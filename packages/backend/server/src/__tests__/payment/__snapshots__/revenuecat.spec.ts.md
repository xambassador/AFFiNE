# Snapshot report for `src/__tests__/payment/revenuecat.spec.ts`

The actual snapshot is saved in `revenuecat.spec.ts.snap`.

Generated by [AVA](https://avajs.dev).

## should resolve product mapping consistently (whitelist, override, unknown)

> should map product for whitelist/override/unknown

    {
      override: {
        customMonthly: {
          plan: 'pro',
          recurring: 'monthly',
        },
      },
      unknown: null,
      whitelist: {
        aiAnnual: {
          plan: 'ai',
          recurring: 'yearly',
        },
        proAnnual: {
          plan: 'pro',
          recurring: 'yearly',
        },
        proMonthly: {
          plan: 'pro',
          recurring: 'monthly',
        },
      },
    }

## should standardize RC subscriber response and upsert subscription with observability fields

> should standardize payload and have events

    {
      activatedCount: 1,
      canceledCount: 0,
      dbObservability: {
        iapStore: 'app_store',
        provider: 'revenuecat',
        rcEntitlement: 'Pro',
        rcExternalRef: 'orig-tx-1',
        rcProductId: 'app.affine.pro.Annual',
      },
      lastActivated: {
        plan: 'pro',
        recurring: 'yearly',
      },
      subscriberCount: 1,
    }

## should process expiration/refund by deleting subscription and emitting canceled

> should process expiration/refund and emit canceled

    {
      activatedCount: 0,
      canceledCount: 1,
      finalDBCount: 0,
      lastCanceled: {
        plan: 'pro',
        recurring: 'yearly',
      },
      subscriberCount: 1,
    }

## should enqueue per-user reconciliation jobs for existing RC active/trialing/past_due subscriptions

> should enqueue per-user RC reconciliation jobs (deduplicated by userId)

    {
      queued: [
        {
          name: 'nightly.revenuecat.syncUser',
          opts: {
            attempts: 3,
            backoff: {
              delay: 60000,
              type: 'exponential',
            },
            jobId: 'nightly-rc-sync-u1',
          },
          payload: {
            userId: 'u1',
          },
        },
        {
          name: 'nightly.revenuecat.syncUser',
          opts: {
            attempts: 3,
            backoff: {
              delay: 60000,
              type: 'exponential',
            },
            jobId: 'nightly-rc-sync-u2',
          },
          payload: {
            userId: 'u2',
          },
        },
      ],
      uniqueJobCount: 2,
    }

## should activate subscriptions via webhook for whitelisted products across stores (iOS/Android)

> should activate subscriptions via webhook for whitelisted products across stores (iOS/Android)

    {
      results: [
        {
          activatedCount: 1,
          name: 'Pro monthly on iOS',
          rec: {
            iapStore: 'app_store',
            plan: 'pro',
            provider: 'revenuecat',
            rcEntitlement: 'Pro',
            rcExternalRef: 'orig-ios-1',
            rcProductId: 'app.affine.pro.Monthly',
            recurring: 'monthly',
            status: 'active',
          },
        },
        {
          activatedCount: 1,
          name: 'AI annual on Android',
          rec: {
            iapStore: 'play_store',
            plan: 'ai',
            provider: 'revenuecat',
            rcEntitlement: 'AI',
            rcExternalRef: 'token-android-1',
            rcProductId: 'app.affine.pro.ai.Annual',
            recurring: 'yearly',
            status: 'active',
          },
        },
      ],
    }

## should keep active and advance period dates when a trialing subscription renews

> should keep active after trial renewal

    {
      activatedCount: 2,
      canceledCount: 0,
      status: 'active',
    }

## should remove or cancel the record and revoke entitlement when a trialing subscription expires

> should remove record

    {
      canceledCount: 1,
      finalDBCount: 0,
    }

## should set canceledAt and keep active until expiration when will_renew is false (cancellation before period end)

> should keep active until period end when will_renew is false

    {
      activatedCount: 1,
      canceledCount: 0,
      hasCanceledAt: true,
      status: 'active',
    }

## should retain record as past_due (inactive but not expired) and NOT emit canceled event

> should retain past_due record and NOT emit canceled event

    {
      canceledCount: 0,
      status: 'past_due',
    }

## should skip RC upsert when Stripe active already exists for same plan

> should skip RC upsert when Stripe active already exists

    {
      activatedCount: 0,
      hasRCRecord: false,
    }

## should reconcile and fix missing or out-of-order states for revenuecat Active/Trialing/PastDue records

> should reconcile and fix missing or out-of-order states for revenuecat records

    {
      activatedCount: 1,
      canceledCount: 0,
      subscriberCount: 1,
    }

## should treat refund as early expiration and revoke immediately

> should delete record and emit canceled on refund

    {
      canceledCount: 1,
      finalDBCount: 0,
    }

## should ignore non-whitelisted productId and not write to DB

> should ignore non-whitelisted productId and not write to DB

    {
      activatedCount: 0,
      canceledCount: 0,
      dbCount: 0,
    }

## should map via entitlement+duration when productId not whitelisted (P1M/P1Y only)

> should map via entitlement+duration fallback and ignore unsupported durations

    {
      aiViaFallback: {
        plan: 'ai',
        provider: 'revenuecat',
        recurring: 'yearly',
      },
      eventsCounts: {
        afterFirst: {
          a: 1,
          c: 0,
        },
        afterSecond: {
          a: 2,
          c: 0,
        },
        afterThird: {
          a: 2,
          c: 0,
        },
      },
      proViaFallback: {
        plan: 'pro',
        provider: 'revenuecat',
        recurring: 'monthly',
      },
      totalCount: 2,
    }
